<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Levels – Quiz Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#F2F2F2; --card:#fff; --text:#1f2a37; --muted:#6b7280;
    --accent:#2B445B; --hoverBg:#ADE2D7; --hoverText:#2B445B;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Red Hat Display", system-ui, Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{margin:0 0 12px;font-weight:800}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid #eee}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;font:inherit;background:white}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer;transition:transform .12s,background .12s,color .12s}
  .btn:hover{transform:translateY(-1px);background:var(--hoverBg);color:var(--hoverText)}
  .hidden{display:none !important}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .stats{display:grid;grid-template-columns:repeat(3,minmax(250px,1fr));gap:12px}
  .stat{background:#fff;border:1px solid #eee;border-radius:var(--radius);padding:16px}
  .stat h3{margin:0 0 6px;font-size:14px;color:var(--muted)}
  .stat .big{font-size:28px;font-weight:800}
  #latest{max-height:360px;overflow:auto;border:1px solid #eee;border-radius:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f5f5f5;text-align:left;font-size:14px}
  th{font-weight:800;position:sticky;top:0;background:#fff}
  .badge{display:inline-block;background:#f3f4f6;border-radius:10px;padding:4px 8px;font-size:12px}

  /* Excel export card + button (Excel green) */
  .excel-box{ background:#217346; color:#fff; }
  .excel-box label{ color:#e6f5ec; }
  .excel-box .muted{ color:#e6f5ec; }
  .btn-excel{ background:#1b5e34; color:#fff; }
  .btn-excel:hover{ transform:translateY(-1px); filter:brightness(1.05); }
  .excel-box input{ background:#fff; color:#111; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Quiz Admin</h1>

  <!-- Login -->
  <div id="loginCard" class="card">
    <form class="row" onsubmit="__adminLogin(event)">
      <div>
        <label>Email</label>
        <input id="adminEmail" type="email" placeholder="admin@levelsacademy.ge" required>
      </div>
      <div>
        <label>Password</label>
        <input id="adminPass" type="password" required>
      </div>
      <button class="btn" type="submit">Sign in</button>
      <div id="who" class="muted"></div>
      <button class="btn right hidden" id="logoutBtn" type="button" onclick="__adminLogout()">Sign out</button>
    </form>
    <div class="muted" style="margin-top:6px">
      Reads are restricted to your admin email via Firestore rules. (No reCAPTCHA.)
    </div>
  </div>

  <!-- Controls -->
  <div id="controls" class="card hidden" style="margin-top:12px">
    <div class="row">
      <div>
        <label>Quick range</label>
        <select id="quick">
          <option value="today">Today</option>
          <option value="week">This week</option>
          <option value="month" selected>This month</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
      <div>
        <label>From</label>
        <input id="from" type="date"/>
      </div>
      <div>
        <label>To</label>
        <input id="to" type="date"/>
      </div>
      <button class="btn" id="apply" type="button">Apply</button>
      <div class="right"></div>
      <div>
        <label>Search (name/email)</label>
        <input id="search" placeholder="type to filter…"/>
      </div>
      <button class="btn" id="refresh" type="button">Refresh</button>
    </div>
  </div>

  <!-- Stats -->
  <div id="dash" class="stats hidden" style="margin-top:12px">
    <div class="stat">
      <h3>Total submissions</h3>
      <div class="big" id="totalCount">—</div>
      <div class="muted" id="rangeCaption"></div>
    </div>
    <div class="stat">
      <h3>Average score (excludes “quit &lt; 15”)</h3>
      <div class="big" id="avgScore">—</div>
      <div class="muted" id="avgNote"></div>
    </div>
    <div class="stat">
      <h3>Submissions chart</h3>
      <canvas id="chart" height="90"></canvas>
    </div>
  </div>

  <!-- Excel export (Excel green) -->
  <div id="exportCard" class="card excel-box hidden" style="margin-top:12px">
    <div class="row" style="align-items:flex-end">
      <h3 style="margin:0 0 8px 0; flex:1 0 100%">Download Excel</h3>

      <div>
        <label>From</label>
        <input id="xFrom" type="date" />
      </div>
      <div>
        <label>To</label>
        <input id="xTo" type="date" />
      </div>

      <button id="xDownloadBtn" class="btn btn-excel" type="button">Download .xlsx</button>
    </div>
    <div class="muted">Exports all submissions with <strong>finishedAt</strong> between these dates.</div>
  </div>

  <!-- Latest 5 -->
  <div id="listCard" class="card hidden" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Latest submissions</h3>
      <button id="loadMore" class="btn" type="button">Load more</button>
    </div>
    <div id="latest" style="margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>Time</th><th>Name</th><th>Email</th><th>Phone</th>
            <th>Level</th><th>Score</th><th>Duration</th><th>Gave up</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase (no App Check) -->
<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, query, where, orderBy, limit, getDocs, startAfter, Timestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Your Firebase project config
  const firebaseConfig = {
    apiKey: "AIzaSyDofnLqwSpjSJ9C9NEabCNSRBvTHraf2YA",
    authDomain: "levels-quiz-c8fc3.firebaseapp.com",
    projectId: "levels-quiz-c8fc3",
    storageBucket: "levels-quiz-c8fc3.firebasestorage.app",
    messagingSenderId: "687807069195",
    appId: "1:687807069195:web:c7041de1c1117ee4671b0e"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // --- helpers ---
  const $ = s => document.querySelector(s);
  const fmt2 = n => String(n).padStart(2,'0');
  const fmtDur = s => `${Math.floor((+s||0)/60)}:${fmt2((+s||0)%60)}`;
  const toDateInput = d => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;

  // --- auth ---
  async function doLogin(e){
    e?.preventDefault?.();
    const email = $('#adminEmail').value.trim();
    const pass  = $('#adminPass').value;
    await signInWithEmailAndPassword(auth, email, pass);
  }
  async function doLogout(){ await signOut(auth); }
  window.__adminLogin = doLogin;
  window.__adminLogout = doLogout;

  onAuthStateChanged(auth, async (user) => {
    const authed = !!user;
    $('#logoutBtn').classList.toggle('hidden', !authed);
    $('#who').textContent = authed ? `Signed in as ${user.email}` : '';
    ['controls','dash','listCard','exportCard'].forEach(id => $('#'+id).classList.toggle('hidden', !authed));
    if(authed){
      initRanges();
      initExportDates();
      await loadAll();
      await loadLatest(true);
      $('#xDownloadBtn').onclick = downloadExcelRange;
      $('#loadMore').onclick = () => loadLatest(false);
      $('#apply').onclick = loadAll;
      $('#refresh').onclick = loadAll;
      $('#search').oninput = filterTable;
      $('#quick').onchange = applyQuick;
    }else{
      // clear UI
      if(chart){ chart.destroy(); chart=null; }
      $('#tbody').innerHTML='';
      $('#totalCount').textContent='—';
      $('#avgScore').textContent='—';
      $('#avgNote').textContent='';
      $('#rangeCaption').textContent='';
    }
  });

  // --- ranges / filters (dashboard) ---
  function initRanges(){
    const now = new Date();
    $('#from').value = toDateInput(new Date(now.getFullYear(), now.getMonth(), 1));
    $('#to').value = toDateInput(now);
  }
  function applyQuick(){
    const now = new Date();
    const val = $('#quick').value;
    let from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let to = now;
    if(val==='today'){
      // midnight today to now
    }else if(val==='week'){
      // Monday start (approx)
      const day = from.getDay() || 7;
      from.setDate(from.getDate() - (day-1));
    }else if(val==='month'){
      from = new Date(now.getFullYear(), now.getMonth(), 1);
    }else{ return; } // custom
    $('#from').value = toDateInput(from);
    $('#to').value = toDateInput(to);
  }

  // --- export dates (independent of dashboard controls) ---
  function initExportDates(){
    const now = new Date();
    $('#xFrom').value = toDateInput(new Date(now.getFullYear(), now.getMonth(), 1));
    $('#xTo').value = toDateInput(now);
  }

  // --- data holders ---
  let chart = null;
  let latestCursor = null;
  let latestRows = []; // in-range, for search/table

  // --- load range (stats + chart + table based on dashboard From/To) ---
  async function loadAll(){
    const fromD = new Date($('#from').value);
    const toD = new Date($('#to').value);
    toD.setHours(23,59,59,999);
    $('#rangeCaption').textContent = `${fromD.toDateString()} – ${toD.toDateString()}`;

    // Query by finishedAt (we set this in quiz.html as serverTimestamp)
    const qRef = query(
      collection(db,'attempts'),
      where('finishedAt','>=', Timestamp.fromDate(fromD)),
      where('finishedAt','<=', Timestamp.fromDate(toD)),
      orderBy('finishedAt','asc')
    );

    const snap = await getDocs(qRef);
    const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));

    // Totals
    $('#totalCount').textContent = rows.length.toString();

    // Average score excluding quit < 15
    const elig = rows.filter(r => !(r.giveUp === true && Number(r.answeredCount||0) < 15));
    const avg = elig.length ? (elig.reduce((a,b)=>a + Number(b.rawScore||0), 0) / elig.length).toFixed(1) : '—';
    $('#avgScore').textContent = avg;
    $('#avgNote').textContent = `Eligible: ${elig.length} of ${rows.length}`;

    // Chart by day
    const byDay = {};
    rows.forEach(r=>{
      const when = r.finishedAt?.toDate?.() || r.timestamp?.toDate?.();
      if(!when) return;
      const key = when.toISOString().slice(0,10);
      byDay[key] = (byDay[key]||0)+1;
    });
    const labels = Object.keys(byDay).sort();
    const data = labels.map(k => byDay[k]);
    drawChart(labels, data);

    // Table data (latest first)
    latestRows = rows.slice().sort((a,b) =>
      (b.finishedAt?.toMillis?.() || 0) - (a.finishedAt?.toMillis?.() || 0)
    );
    renderTable(latestRows.slice(0,5));
    latestCursor = null; // reset paging cursor
  }

  // --- latest paging (global latest, independent of dashboard range) ---
  async function loadLatest(reset=false){
    const base = collection(db,'attempts');
    const q0 = latestCursor
      ? query(base, orderBy('finishedAt','desc'), startAfter(latestCursor), limit(10))
      : query(base, orderBy('finishedAt','desc'), limit(10));
    const snap = await getDocs(q0);
    if(reset){ $('#tbody').innerHTML=''; latestCursor=null; }
    if(snap.docs.length){
      latestCursor = snap.docs[snap.docs.length-1];
      const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      appendRows(rows);
    }
  }

  function drawChart(labels, data){
    const ctx = document.getElementById('chart');
    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ data, label:'Submissions', tension:.25, fill:false }] },
      options:{
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
      }
    });
  }

  function renderTable(rows){
    const tbody = $('#tbody'); tbody.innerHTML='';
    appendRows(rows);
  }
  function appendRows(rows){
    const tbody = $('#tbody');
    rows.forEach(r=>{
      const when = r.finishedAt?.toDate?.() || r.timestamp?.toDate?.();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${when ? when.toISOString().replace('T',' ').replace('Z','') : ''}</td>
        <td>${(r.firstName||'') + ' ' + (r.lastName||'')}</td>
        <td>${r.email||''}</td>
        <td>${r.phone||''}</td>
        <td><span class="badge">${r.level||''}</span></td>
        <td>${Number(r.rawScore||0)}/${Number(r.rawTotal||0)} (=${Number(r.scaledTo80||0)}/80)</td>
        <td>${fmtDur(Number(r.elapsedSec||0))}</td>
        <td>${r.giveUp ? 'Yes' : 'No'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Local search on in-range table
  function filterTable(){
    const q = ($('#search').value||'').toLowerCase().trim();
    const base = latestRows;
    const filtered = !q ? base : base.filter(r =>
      (r.firstName||'').toLowerCase().includes(q) ||
      (r.lastName||'').toLowerCase().includes(q) ||
      (r.email||'').toLowerCase().includes(q)
    );
    renderTable(filtered.slice(0, Math.max(5, filtered.length)));
  }

  // --- Excel export (independent From/To in the green card) ---
  async function downloadExcelRange(){
    try{
      const fromVal = $('#xFrom').value;
      const toVal   = $('#xTo').value;
      if(!fromVal || !toVal){ alert('Please select both From and To dates.'); return; }

      const fromD = new Date(fromVal);
      const toD   = new Date(toVal);
      toD.setHours(23,59,59,999); // include the whole 'To' day

      // Query Firestore by finishedAt within chosen export window
      const qRef = query(
        collection(db, 'attempts'),
        where('finishedAt','>=', Timestamp.fromDate(fromD)),
        where('finishedAt','<=', Timestamp.fromDate(toD)),
        orderBy('finishedAt','asc')
      );
      const snap = await getDocs(qRef);
      const docs = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!docs.length){ alert('No submissions in that date range.'); return; }

      // Flatten for Excel
      const rows = docs.map(r => {
        const finished = r.finishedAt?.toDate?.() || r.timestamp?.toDate?.() || null;
        const durSec = Number(r.elapsedSec||0);
        return {
          FinishedAt:  finished || null,
          FirstName:   r.firstName || '',
          LastName:    r.lastName  || '',
          Email:       r.email     || '',
          Phone:       r.phone     || '',
          Level:       r.level     || '',
          Score:       Number(r.rawScore||0),
          Total:       Number(r.rawTotal||0),
          ScaledTo80:  Number(r.scaledTo80||0),
          DurationSec: durSec,
          DurationMMSS:`${Math.floor(durSec/60)}:${fmt2(durSec%60)}`,
          GaveUp:      !!r.giveUp,
          AnsweredCount: Number(r.answeredCount||0),
          QuitEarlyBefore15: !!r.quitEarlyBefore15,
          Plan:        r.plan || '',
          DOB:         r.dob  || '',
          AttemptId:   r.attemptId || '',
          QuizVersion: r.quizVersion || '',
          UserAgent:   r.userAgent || ''
        };
      });

      // Build workbook
      const ws = XLSX.utils.json_to_sheet(rows, { cellDates:true });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Results');

      const filename = `quiz_results_${fromVal}_to_${toVal}.xlsx`;
      XLSX.writeFile(wb, filename, { bookType:'xlsx', cellDates:true });

    }catch(err){
      console.error(err);
      alert('Export failed. Check console for details.');
    }
  }
</script>
</body>
</html>

