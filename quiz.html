<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Level Placement Test</title>
  <meta name="description" content="One question per card, 45-minute timer." />

  <!-- Red Hat Display -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F2F2F2;
      --card:#ffffff;
      --accent:#2B445B;
      --text:#1f2a37;
      --muted:#6b7280;
      --radius:18px;
      --navBtnWidth:140px;        /* equal width for Prev/Next */
      --badgeW: 92px;             /* timer & Q1 pill same width */
      --hoverBg:#ADE2D7;          /* requested hover background */
      --hoverText:#2B445B;        /* requested hover text color */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Red Hat Display', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* wrapper: full width, 20px top/left/right padding, no shadow anywhere */
    #app{
      width:100%;
      max-width:none;
      margin:0 auto;
      padding:20px 20px;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
    }
    .hidden{display:none !important}
    .row{display:flex; flex-wrap:wrap; gap:16px}
    .field{flex:1 1 260px; display:flex; flex-direction:column; gap:6px}
    .field label{font-size:14px; color:var(--muted)}
    .field input,.field select{
      appearance:none; -webkit-appearance:none;
      border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; font-size:16px; outline:none; background:white;
      font-family:'Red Hat Display', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .field input:focus,.field select:focus{border-color:var(--accent)}

    /* Buttons */
    .btn{
      border:0;
      background:#23B899;          /* default (used by Start & Finish if not overridden) */
      color:white;
      padding:12px 18px;
      border-radius:999px;
      font-weight:800;             /* Extra Bold for buttons */
      font-family:'Red Hat Display', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      cursor:pointer;
      transition:transform .12s ease, filter .12s ease, opacity .12s ease, background-color .12s ease, color .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid #cbd5e1 }

    /* Specific button colors per your request */
    .navBtn{ width: var(--navBtnWidth); }
    #nextBtn{ background:#2B445B; color:#fff }
    #nextBtn:hover{ background:var(--hoverBg); color:var(--hoverText) }

    #prevBtn{ /* ghost by default */ }
    #prevBtn:hover{ background:var(--hoverBg); color:var(--hoverText); border-color:var(--hoverBg) }

    #giveUpBtn{ background:#F66E6E; color:#fff; border:none }
    #giveUpBtn:hover{ opacity:.7; color:var(--hoverText) }

    /* Timer + progress */
    .timerStrip{display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:12px}
    .badge{
      width:var(--badgeW);
      background:#f3f4f6; color:#111827; font-weight:700; padding:8px 12px; border-radius:12px; text-align:center
    }
    .progress{height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; width:0; background:linear-gradient(90deg,#2B445B,#23B899); transition:width .25s ease}
    .muted{color:var(--muted); font-size:14px}

    /* Q# pill + question */
    .pill{
      width:var(--badgeW);
      border-radius:999px;
      padding:6px 10px;
      background:#f3f4f6;
      display:inline-block;
      text-align:center;
      margin-bottom:16px;          /* extra gap before question */
    }
    .qtext{
      font-size:20px; font-weight:700; line-height:1.34; margin-bottom:14px;
      letter-spacing:0; word-spacing:0;   /* ensures no odd spacing */
    }

    /* Options */
    .opts{display:flex; flex-direction:column; gap:10px; margin:14px 0 4px}
    .opt{
      padding:12px 14px; border:1px solid #e5e7eb; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer;
      transition:transform .08s ease, border-color .12s ease, background .12s ease;
      background:white;
    }
    .opt input{accent-color:#2B445B; margin:0}
    .opt:hover{transform:translateY(-1px); border-color:#cbd5e1; background:#fafafa}
    .opt.selected{ background:var(--hoverBg); border-color:var(--hoverBg) } /* selected option pill */

    .foot{display:flex; justify-content:space-between; align-items:center; margin-top:16px}

    .title{font-weight:800; font-size:22px; margin-bottom:6px}
    .subtitle{color:var(--muted);}

    .resultScore{font-size:42px; font-weight:800}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media (max-width:600px){ #app{padding:20px 14px} .title{font-size:20px} .qtext{font-size:18px} }
  </style>

  <!-- Load questions first (must set window.QUESTIONS) -->
  <script src="questions.js"></script>
</head>
<body>
  <div id="app">
    <!-- Registration -->
    <section id="step-register" class="card">
      <div class="title">English Level Placement Test</div>
      <div class="subtitle">Please complete the form to begin. You will have <strong>45 minutes</strong>.</div>
      <form id="regForm" autocomplete="on">
        <div class="row">
          <div class="field"><label for="firstName">First name</label><input id="firstName" name="firstName" required placeholder="Name" /></div>
          <div class="field"><label for="lastName">Last name</label><input id="lastName" name="lastName" required placeholder="Surname" /></div>
          <div class="field"><label for="dob">Date of Birth</label><input id="dob" name="dob" type="date" required /></div>
          <div class="field"><label for="phone">Phone number</label><input id="phone" name="phone" type="tel" inputmode="tel" placeholder="+995 5XX XX XX XX" required /></div>
          <div class="field"><label for="email">Email</label><input id="email" name="email" type="email" placeholder="name@example.com" required /></div>
          <div class="field">
            <label for="plan">Are you planning on taking an English Language Course at Levels Academy?</label>
            <select id="plan" name="plan" required>
              <option value="" disabled selected>Select...</option>
              <option>Yes</option>
              <option>No</option>
              <option>Not sure yet</option>
            </select>
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="btn" id="startBtn" type="submit">Start the test</button>
          <span class="muted">One question at a time.</span>
        </div>
      </form>
    </section>

    <!-- Quiz -->
    <section id="step-quiz" class="card hidden" aria-live="polite">
      <div class="timerStrip">
        <div class="badge mono" id="timeLeft">45:00</div>
        <div style="flex:1; margin:0 12px">
          <div class="progress" aria-label="Progress"><span id="progressBar"></span></div>
          <div class="muted" style="margin-top:8px"><span id="progressText">Question 1</span></div>
        </div>
        <button class="btn" id="giveUpBtn" type="button" title="End the test now and see your results">Give up</button>
      </div>

      <div id="qCard">
        <div class="pill mono" id="qTag">Q1</div>
        <div class="qtext" id="qText">Question text</div>
        <div class="opts" id="qOptions"></div>
        <div class="foot">
          <button class="btn ghost navBtn" id="prevBtn" type="button">Previous</button>
          <div class="actions">
            <span class="muted" id="saveHint"></span>
            <button class="btn navBtn" id="nextBtn" type="button">Next</button>
            <button class="btn" id="submitBtn" type="button">Finish</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Results (no per-question correctness shown) -->
    <section id="step-result" class="card hidden">
      <div class="title">Your Result</div>
      <div class="row" style="align-items:center">
        <div class="resultScore"><span id="scoreText">0</span> / <span id="totalText">80</span></div>
        <div style="padding:10px 16px; border-radius:12px; background:#f3f4f6; font-weight:800; font-size:28px; margin-left:12px" id="levelText">A1</div>
      </div>
      <div class="subtitle" id="timeUsedText"></div>

      <div class="actions" style="margin:8px 0 2px">
        <button id="restartBtn" class="btn ghost">Restart</button>
      </div>
    </section>
  </div>

  <script>
    /* ------------ CONFIG ------------- */
    const TEST_MINUTES = 45;
    const STORAGE_KEY = 'levelsQuiz.v1';

    // CEFR mapping per your ranges
    function levelFromScore(score80){
      if(score80 <= 9) return 'A1';
      if(score80 <= 27) return 'A2';
      if(score80 <= 45) return 'B1';
      if(score80 <= 63) return 'B2';
      return 'C1';
    }

    const $ = (sel) => document.querySelector(sel);
    const fmt = (n) => String(n).padStart(2,'0');

    let QUESTIONS = window.QUESTIONS || [];

    // Added earlyA0 flag
    const state = { user:null, index:0, answers:{}, startedAt:null, giveUp:false, earlyA0:false };

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      $('#saveHint').textContent = 'Saved';
      setTimeout(()=>$('#saveHint').textContent='', 900);
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s && s.user && s.startedAt){
          Object.assign(state, s);
          const elapsed = Date.now() - s.startedAt;
          if(elapsed > TEST_MINUTES*60*1000){ localStorage.removeItem(STORAGE_KEY); return; }
          $('#step-register').classList.add('hidden');
          $('#step-quiz').classList.remove('hidden');
          renderQuestion();
          startTimer();
        }
      }catch(e){ console.warn('load failed', e); }
    }

    /* -------- Registration ---------- */
    $('#regForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      state.user = data;
      state.index = 0;
      state.answers = {};
      state.startedAt = Date.now();
      state.giveUp = false;
      state.earlyA0 = false; // reset
      save();
      $('#step-register').classList.add('hidden');
      $('#step-quiz').classList.remove('hidden');
      renderQuestion();
      startTimer();
    });

    /* ------------ Quiz -------------- */
    function updateOptionSelectionUI(){
      const container = $('#qOptions');
      container.querySelectorAll('.opt').forEach(l=>l.classList.remove('selected'));
      const checked = container.querySelector('input[name="opt"]:checked');
      if(checked){ checked.closest('.opt').classList.add('selected'); }
    }

    function renderQuestion(){
      const i = state.index;
      const total = QUESTIONS.length;
      const q = QUESTIONS[i];
      $('#qTag').textContent = `Q${i+1}`;
      $('#qText').textContent = q.text;  // textContent prevents weird spacing
      $('#progressText').textContent = `Question ${i+1} of ${total}`;
      $('#progressBar').style.width = ((i)/Math.max(1,total) * 100)+'%';

      const container = $('#qOptions');
      container.innerHTML = '';
      const prevValue = state.answers[q.id];
      q.options.forEach((opt, idx)=>{
        const id = `q${q.id}_${idx}`;
        const div = document.createElement('label');
        div.className = 'opt';
        div.innerHTML = `<input type="radio" name="opt" id="${id}" value="${opt}"> <span>${opt}</span>`;
        container.appendChild(div);
      });

      container.onchange = updateOptionSelectionUI;

      if(prevValue){
        const input = [...container.querySelectorAll('input')].find(i=>i.value===prevValue);
        if(input){ input.checked = true; }
      }
      updateOptionSelectionUI();

      $('#prevBtn').disabled = (i===0);
      $('#nextBtn').classList.toggle('hidden', i===total-1);
      $('#submitBtn').classList.toggle('hidden', i!==total-1);
    }

    function captureAnswer(){
      const q = QUESTIONS[state.index];
      const chosen = document.querySelector('input[name="opt"]:checked');
      if(chosen){ state.answers[q.id] = chosen.value; save(); }
    }

    // NEW: early stop check for first 40 questions -> A0
    function checkEarlyStopA0(){
      // Only applies if we have at least 40 questions
      if(QUESTIONS.length < 40) return false;

      const first40 = QUESTIONS.slice(0, 40);
      let answered = 0;
      let correctFirst40 = 0;

      for(const q of first40){
        const valRaw = state.answers[q.id];
        if(valRaw != null){
          answered++;
          const picked = (valRaw || '').trim().toLowerCase();
          const corr = (q.correct || '').trim().toLowerCase();
          if(picked && picked === corr) correctFirst40++;
        }
      }

      // Trigger only when ALL first 40 are answered and <=5 are correct
      if(answered === first40.length && correctFirst40 < 35){
        state.earlyA0 = true;
        save();
        finish(false);  // stop quiz and show result
        return true;
      }
      return false;
    }

    document.getElementById('nextBtn').addEventListener('click', ()=>{
      captureAnswer();
      if(checkEarlyStopA0()) return; // stop here if A0 condition met
      if(state.index < QUESTIONS.length-1){ state.index++; save(); renderQuestion(); }
    });
    document.getElementById('prevBtn').addEventListener('click', ()=>{
      captureAnswer();
      // No early-stop check on going back
      if(state.index > 0){ state.index--; save(); renderQuestion(); }
    });
    document.getElementById('submitBtn').addEventListener('click', ()=>{
      captureAnswer();
      if(checkEarlyStopA0()) return; // stop here if A0 condition met
      finish(false);
    });
    document.getElementById('giveUpBtn').addEventListener('click', ()=>{
      if(confirm('Are you sure you want to end the test now?')){
        captureAnswer(); state.giveUp = true; finish(false);
      }
    });

    /* ------------ Timer ------------- */
    let tickHandle = null;
    function startTimer(){
      const endAt = state.startedAt + TEST_MINUTES*60*1000;
      function tick(){
        const msLeft = Math.max(0, endAt - Date.now());
        const sec = Math.floor(msLeft/1000);
        const mm = Math.floor(sec/60);
        const ss = sec % 60;
        $('#timeLeft').textContent = `${fmt(mm)}:${fmt(ss)}`;
        if(sec <= 0){
          finish(true);
        }else{
          tickHandle = setTimeout(tick, 250);
        }
      }
      if(tickHandle) clearTimeout(tickHandle);
      tick();
    }

    /* ------------ Finish (no review UI) ------------ */
    function finish(timeUp){
      if(tickHandle) clearTimeout(tickHandle);

      const total = QUESTIONS.length;
      let correct = 0;
      for(const q of QUESTIONS){
        const picked = state.answers[q.id];
        if((picked||'').trim().toLowerCase() === (q.correct||'').trim().toLowerCase()){
          correct++;
        }
      }

      const elapsedSec = Math.floor((Date.now() - (state.startedAt || Date.now()))/1000);
      const scaled80 = Math.round(correct * 80 / Math.max(1,total));
      let level = levelFromScore(scaled80);

      // Override level to A0 if early-stop rule was triggered
      if(state.earlyA0){
        level = 'A0';
      }

      // --- Build payload for Firestore (admin dashboard) ---
      const answeredCount = Object.keys(state.answers||{}).length;
      const payload = {
        attemptId: (crypto?.randomUUID?.() || String(Date.now())),
        firstName: state.user?.firstName || "",
        lastName:  state.user?.lastName  || "",
        dob:       state.user?.dob       || "",
        phone:     state.user?.phone     || "",
        email:     state.user?.email     || "",
        plan:      state.user?.plan      || "",
        giveUp:    !!state.giveUp,

        elapsedSec,
        rawScore: correct,
        rawTotal: total,
        scaledTo80: scaled80,
        level,

        answeredCount,
        quitEarlyBefore15: !!state.giveUp && answeredCount < 15,
        quizVersion: "v1",

        // NEW: flag to know why A0 happened
        earlyStopA0: !!state.earlyA0,

        startedAt: state.startedAt,          // ms since epoch; module converts to Date
        userAgent: navigator.userAgent
      };

      if (window.submitAttemptToFirestore) {
        window.submitAttemptToFirestore(payload);
      }

      // --- Results UI ---
      $('#step-quiz').classList.add('hidden');
      $('#step-result').classList.remove('hidden');
      $('#scoreText').textContent = `${correct}`;
      $('#totalText').textContent = `${total}`;
      $('#levelText').textContent = level;

      const mm = Math.floor(elapsedSec/60), ss = elapsedSec%60;
      $('#timeUsedText').textContent = `Time used: ${fmt(mm)}:${fmt(ss)}  ·  Scaled score for level: ${scaled80}/80` + (state.giveUp? '  ·  (Gave up early)':'');
      localStorage.removeItem(STORAGE_KEY);
    }

    document.getElementById('restartBtn').addEventListener('click', ()=>{
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    });

    // Resume if user refreshes mid-test
    load();
  </script>

  <!-- Firebase (no App Check) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyDofnLqwSpjSJ9C9NEabCNSRBvTHraf2YA",
      authDomain: "levels-quiz-c8fc3.firebaseapp.com",
      projectId: "levels-quiz-c8fc3",
      storageBucket: "levels-quiz-c8fc3.firebasestorage.app",
      messagingSenderId: "687807069195",
      appId: "1:687807069195:web:c7041de1c1117ee4671b0e"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Called from finish() to save one attempt
    window.submitAttemptToFirestore = async (payload) => {
      try {
        await addDoc(collection(db, "attempts"), {
          ...payload,
          timestamp: serverTimestamp(),
          finishedAt: serverTimestamp(),
          startedAt: payload.startedAt ? new Date(payload.startedAt) : null,
        });
      } catch (e) {
        console.warn("Firestore write failed:", e);
      }
    };
  </script>
</body>
</html>

